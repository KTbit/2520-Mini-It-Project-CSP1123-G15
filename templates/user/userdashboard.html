{% extends "nav_base.html" %}
{% block title %}My Recipe Collections Â· Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2><i class="bi bi-collection"></i> My Recipe Collections</h2>
    <p class="text-muted">Organize your saved recipes here</p>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCollectionModal">
    <i class="bi bi-plus-circle"></i> New Collection
  </button>
</div>

<!-- Collections grid -->
{% if collections %}
<div class="row g-4">
  {% for collection in collections %}
  <div class="col-md-6 col-lg-4">
    <a href="{{ url_for('view_collection', collection_id=collection.id) }}" class="text-decoration-none">
      <div class="card h-100 shadow-sm hover-card">
        <!-- Collection preview (show first 4 recipe images) -->
        <div class="collection-preview">
          {% set preview_recipes = collection.recipes.limit(4).all() %}
          {% if preview_recipes %}
          <div class="row g-0">
            {% for recipe in preview_recipes %}
            <div class="col-6">
              {% if recipe.recipe_image %}
              <img src="{{ recipe.recipe_image }}" 
                   alt="{{ recipe.recipe_name }}"
                   class="img-fluid"
                   style="height: 120px; width: 100%; object-fit: cover;">
              {% else %}
              <div class="bg-light d-flex align-items-center justify-content-center" 
                   style="height: 120px;">
                <i class="bi bi-image text-muted"></i>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-collection-preview d-flex align-items-center justify-content-center">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #ddd;"></i>
          </div>
          {% endif %}
        </div>

        <div class="card-body">
          <h5 class="card-title">
            {{ collection.name }}
            {% if collection.is_default %}
            <span class="badge bg-primary">Default</span>
            {% endif %}
          </h5>
          {% if collection.description %}
          <p class="card-text text-muted small">{{ collection.description }}</p>
          {% endif %}
          <p class="card-text">
            <small class="text-muted">
              <i class="bi bi-bookmark-fill"></i> {{ collection.recipes.count() }} recipes
            </small>
          </p>
        </div>

        <!-- Collection actions -->
        <div class="card-footer bg-white border-top-0">
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-grow-1"
                    onclick="event.preventDefault(); window.location.href='{{ url_for('view_collection', collection_id=collection.id) }}'"> <!--possible faux error?-->
              <i class="bi bi-eye"></i> View
            </button>
            {% if not collection.is_default %}
            <button class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#editCollectionModal{{ collection.id }}"
                    onclick="event.preventDefault();">
              <i class="bi bi-pencil"></i>
            </button>
            <form method="post" 
                  action="{{ url_for('delete_collection', collection_id=collection.id) }}"
                  onsubmit="return confirm('Delete this collection? Recipes will be moved to \'My Recipes\'.');"
                  class="d-inline"
                  onclick="event.preventDefault(); this.closest('form').onsubmit() && this.closest('form').submit();">
              <button type="submit" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash"></i>
              </button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
    </a>

    <!-- Edit Collection Modal -->
    {% if not collection.is_default %}
    <div class="modal fade" id="editCollectionModal{{ collection.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Collection</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form method="post" action="{{ url_for('edit_collection', collection_id=collection.id) }}">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Collection Name</label>
                <input type="text" name="name" class="form-control" 
                       value="{{ collection.name }}" required maxlength="100">
              </div>
              <div class="mb-3">
                <label class="form-label">Description (optional)</label>
                <textarea name="description" class="form-control" rows="3" 
                          maxlength="500">{{ collection.description or '' }}</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
  <i class="bi bi-collection" style="font-size: 4rem; color: #ddd;"></i>
  <h4 class="mt-3 text-muted">No collections yet!</h4>
  <p class="text-muted">Create your first collection to start organizing recipes.</p>
  <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#newCollectionModal">
    <i class="bi bi-plus-circle"></i> Create First Collection
  </button>
</div>
{% endif %}

<!-- New Collection Modal -->
<div class="modal fade" id="newCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> New Collection
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('create_collection') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Collection Name *</label>
            <input type="text" name="name" class="form-control" 
                   placeholder="e.g. Quick Dinners, Desserts, Meal Prep"
                   required maxlength="100">
          </div>
          <div class="mb-3">
            <label class="form-label">Description (optional)</label>
            <textarea name="description" class="form-control" rows="3" 
                      placeholder="What kind of recipes will you save here?"
                      maxlength="500"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Create Collection
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.hover-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.hover-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
}

.collection-preview {
  height: 240px;
  overflow: hidden;
  background-color: #f8f9fa;
}

.empty-collection-preview {
  height: 240px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
</style>
{% endblock %}